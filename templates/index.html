<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Virtual Person Talk Demo</title>
  <style>
    body{font-family: Arial, Helvetica, sans-serif; max-width:900px; margin:20px auto}
    #preview{max-width:320px; border:1px solid #ddd; padding:10px}
    textarea{width:100%; height:80px}
    video{max-width:480px; display:block; margin-top:10px}
    .row{display:flex; gap:12px; align-items:center}
    #loading{display:none}
  </style>
</head>
<body>
  <h2>Upload face image → chat → watch the person speak</h2>
  <div>
    <input id="imagefile" type="file" accept="image/*" />
    <button id="uploadBtn">Upload Image</button>
    <div id="preview"></div>
  </div>

  <hr/>
  <div>
    <textarea id="message" placeholder="Type message to virtual person..."></textarea>
    <button id="sendBtn">Send & Animate</button>
    <div id="loading">Generating... please wait (this can be slow on CPU)</div>
  </div>

  <h3>LLM Reply:</h3>
  <div id="reply"></div>

  <h3>Generated Video:</h3>
  <video id="resultVideo" controls></video>

<script>
let uploadedFilename = null;

async function jsonFetch(url, opts){
  const res = await fetch(url, opts);
  const j = await res.json();
  if (!res.ok) throw j;
  return j;
}

document.getElementById('uploadBtn').onclick = async () => {
  const inp = document.getElementById('imagefile');
  if (!inp.files.length) return alert('Choose an image first');
  const fd = new FormData();
  fd.append('image', inp.files[0]);
  try{
    const j = await jsonFetch('/upload_image', {method:'POST', body:fd});
    if (j.image_path) {
      uploadedFilename = j.image_path;
      const url = '/uploads/' + j.image_path;
      document.getElementById('preview').innerHTML = `<img src="${url}" style="max-width:260px">`;
    }
  }catch(e){
    alert('Upload failed: ' + (e.error || JSON.stringify(e)));
    console.error(e);
  }
}

document.getElementById('sendBtn').onclick = async () => {
  if (!uploadedFilename) return alert('Upload an image first');
  const msg = document.getElementById('message').value.trim();
  if (!msg) return alert('Type a message');
  document.getElementById('loading').style.display = 'block';
  try{
    const j = await jsonFetch('/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: msg, image_filename: uploadedFilename})
    });
    document.getElementById('reply').innerText = j.reply_text;
    document.getElementById('resultVideo').src = j.video_url;
  }catch(e){
    alert('Error: ' + (e.error || JSON.stringify(e)));
    console.error(e);
  }finally{
    document.getElementById('loading').style.display = 'none';
  }
}
</script>
</body>
</html>